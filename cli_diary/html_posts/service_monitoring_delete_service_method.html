<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2022-01-05" />
  <title>Service Monitoring, Delete Service Method Presentation</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Iosevka;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        background-color: #232629;
        color: #7a7c7d;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #7a7c7d;  padding-left: 4px; }
    div.sourceCode
      { color: #cfcfc2; background-color: #232629; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #cfcfc2; } /* Normal */
    code span.al { color: #95da4c; background-color: #4d1f24; font-weight: bold; } /* Alert */
    code span.an { color: #3f8058; } /* Annotation */
    code span.at { color: #2980b9; } /* Attribute */
    code span.bn { color: #f67400; } /* BaseN */
    code span.bu { color: #7f8c8d; } /* BuiltIn */
    code span.cf { color: #fdbc4b; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #3daee9; } /* Char */
    code span.cn { color: #27aeae; font-weight: bold; } /* Constant */
    code span.co { color: #7a7c7d; } /* Comment */
    code span.cv { color: #7f8c8d; } /* CommentVar */
    code span.do { color: #a43340; } /* Documentation */
    code span.dt { color: #2980b9; } /* DataType */
    code span.dv { color: #f67400; } /* DecVal */
    code span.er { color: #da4453; text-decoration: underline; } /* Error */
    code span.ex { color: #0099ff; font-weight: bold; } /* Extension */
    code span.fl { color: #f67400; } /* Float */
    code span.fu { color: #8e44ad; } /* Function */
    code span.im { color: #27ae60; } /* Import */
    code span.in { color: #c45b00; } /* Information */
    code span.kw { color: #cfcfc2; font-weight: bold; } /* Keyword */
    code span.op { color: #cfcfc2; } /* Operator */
    code span.ot { color: #27ae60; } /* Other */
    code span.pp { color: #27ae60; } /* Preprocessor */
    code span.re { color: #2980b9; background-color: #153042; } /* RegionMarker */
    code span.sc { color: #3daee9; } /* SpecialChar */
    code span.ss { color: #da4453; } /* SpecialString */
    code span.st { color: #f44f4f; } /* String */
    code span.va { color: #27aeae; } /* Variable */
    code span.vs { color: #da4453; } /* VerbatimString */
    code span.wa { color: #da4453; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Service Monitoring, Delete Service Method Presentation</h1>
<p class="date">01/05/2022</p>
</header>
<p>This is kind of a ‘part 2’ of the <code>service_monitoring_create_service_method</code> post.<br />
In it I presented the service_monitoring app, and what it tries to do and the reasons why it needs to be documented. So if these topics interest you, start there.<br />
This method deletes Systemd or Celery services safely. It also changes the json file, that serves as source of truth for the app, and the dropdown file, that presents the available services.</p>
<p>We start by reading the json file into a string:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>          <span class="cf">with</span> <span class="bu">open</span>(<span class="st">&quot;/home/mic/python/service_monitoring/service_monitoring/dropdown_info.json&quot;</span>, <span class="st">&quot;r&quot;</span>) <span class="im">as</span> f:</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>              servs <span class="op">=</span> f.read()  <span class="co"># It has to be read(), not readlines(), because the latter is a list.</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>          info <span class="op">=</span> json.loads(servs)</span></code></pre></div>
<p>Create an empty list that will user later on:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>      decision_lst <span class="op">=</span> []</span></code></pre></div>
<p>There are two types of inputs for the app’s methods:<br />
1. The information pertains to a specific service.<br />
In that case, the information received by the class will have an existing service name and the method we want to use.<br />
2. The information does not pertain to a specific service.<br />
Here, the class will receive a list with a <code>dummy_service</code> string as the service name, and the method, that is the only thing of relevance in this case.</p>
<p>To filter only the queries to specific services, we verify if the string <code>dummy_service</code> is contained in the variable <code>self.units</code>, that reads from the second member of the list given by the <code>dropdown</code> module.<br />
If it’s not, we question the user if he wants to disable x unit. We’ll do it for all units contained in <code>self.units</code>.<br />
For all units that the user answers affirmatively, there’ll be an entrance on the <code>decision_lst</code> list, that’ll keep the user’s choices for all the queries.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="st">&quot;dummy_service&quot;</span> <span class="kw">not</span> <span class="kw">in</span> self_units:</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> unit <span class="kw">in</span> <span class="va">self</span>.units:</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>              decision <span class="op">=</span> <span class="bu">input</span>(click.style(<span class="ss">f&quot; ++ Do you want to disable unit </span><span class="sc">{</span>unit<span class="sc">}</span><span class="ss">? [y/n] &quot;</span>, fg<span class="op">=</span><span class="st">&quot;bright_white&quot;</span>, bold<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> decision <span class="op">==</span> <span class="st">&quot;y&quot;</span>:</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                  decision_lst.append(<span class="ss">f&quot;</span><span class="sc">{</span>unit<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<p>If, on the other hand, the information available does contain the string <code>dummy_service</code> and relates to a general query, we ask what units he wants to delete. If the answer is nothing, we exit the program. If it’s something, we must be aware that the answer can be multiple services. For this we split the resulting string from the input function into a list of strings, obtained by using <code>split</code> on spaces.<br />
Off course this means that no commas should be added when inputting the list of units to delete.<br />
We add the list’s items to the <code>decision_lst</code> list.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>:</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>          deci <span class="op">=</span> <span class="bu">input</span>(click.style(<span class="st">&quot; ++ What unit(s) do you want to delete? &quot;</span>, fg<span class="op">=</span><span class="st">&quot;bright_white&quot;</span>, bold<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> deci <span class="op">==</span> <span class="st">&quot;&quot;</span>:</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>              sys.exit()</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span>:</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>              decision <span class="op">=</span> deci.split(<span class="st">&quot; &quot;</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> i <span class="kw">in</span> decision:</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>              decision_lst.append(i)</span></code></pre></div>
<p>For each unit chosen, we’ll run consecutively, the following commands:<br />
1. Stop unit.<br />
2. Disable unit.<br />
3. Delete unit file in Systemd directory.<br />
4. Reload Systemd daemon.<br />
5. Reset failed services.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> service <span class="kw">in</span> decision_lst:</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>          cmd15 <span class="op">=</span> <span class="ss">f&quot;sudo systemctl stop </span><span class="sc">{</span>service<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>          subprocess.run(cmd15, shell<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>          cmd16 <span class="op">=</span> <span class="ss">f&quot;sudo systemctl disable </span><span class="sc">{</span>service<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>          subprocess.run(cmd16, shell<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>          cmd18 <span class="op">=</span> <span class="ss">f&quot;sudo rm /usr/lib/systemd/system/</span><span class="sc">{</span>service<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>          subprocess.run(cmd18, shell<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>          cmd17 <span class="op">=</span> <span class="st">&quot;sudo systemctl daemon-reload&quot;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>          subprocess.run(cmd17, shell<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>          cmd19 <span class="op">=</span> <span class="st">&quot;sudo systemctl reset-failed&quot;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>          subprocess.run(cmd19, shell<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
<p>Now we’ll update the json file. Contrary to what is done in <code>create_service</code> method, where this part is done by another module, here we concentrate all operations in the same function. I think this is the best option, and might still change the <code>create_service</code> workflow.</p>
<p>We open the file:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>      monitor <span class="op">=</span> <span class="st">&quot;/home/mic/python/service_monitoring/service_monitoring&quot;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>      data <span class="op">=</span> json.load(<span class="bu">open</span>(<span class="ss">f&quot;</span><span class="sc">{</span>monitor<span class="sc">}</span><span class="ss">/dropdown_info.json&quot;</span>))</span></code></pre></div>
<p>The python structure of the json file is a dictionary, that has, as value, a list of dictionaries, that themselves have lists as values.<br />
As I’m not too accustomed to dictionaries, this can be quickly become overwhelming.<br />
In this case, two scenarios may present themselves: the user intends to erase all units of a service or he just wants to delete some of them.</p>
<p>In the first case we do:<br />
For all entries in the <code>dropinfo</code> list of values, with the dictionary item <code>units</code>; if the contents of the units to erase is equal to the units present for that list member:<br />
1. delete member,<br />
2. open new json file and write updated dictionary to it,<br />
3. delete old json file,<br />
4. rename new file with the name of old,<br />
5. run <code>make_dropdown</code>, that’ll update the services list in the UI.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data[<span class="st">&quot;dropinfo&quot;</span>])):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> decision_lst <span class="op">==</span> data[<span class="st">&quot;dropinfo&quot;</span>][i][<span class="st">&quot;units&quot;</span>]:</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>              data[<span class="st">&quot;dropinfo&quot;</span>].pop(i)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>          <span class="bu">open</span>(<span class="ss">f&quot;</span><span class="sc">{</span>monitor<span class="sc">}</span><span class="ss">/dropdown_info1.json&quot;</span>, <span class="st">&quot;w&quot;</span>).write(json.dumps(data, indent<span class="op">=</span><span class="dv">4</span>, sort_keys<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>          os.remove(<span class="ss">f&quot;</span><span class="sc">{</span>monitor<span class="sc">}</span><span class="ss">/dropdown_info.json&quot;</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>          os.rename(<span class="ss">f&quot;</span><span class="sc">{</span>monitor<span class="sc">}</span><span class="ss">/dropdown_info1.json&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>monitor<span class="sc">}</span><span class="ss">/dropdown_info.json&quot;</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>          make_dropdown()</span></code></pre></div>
<p>For the second case:<br />
1. create list of <code>units</code> lists, contained in each of <code>dropinfo</code> members,<br />
2. verify that list of units to erase is different from all <code>units</code> lists,<br />
3. if that is the case, for each unit to be deleted:<br />
4. we’ll iterate through all members of <code>dropinfo</code>,<br />
5. and if we find the name of one of the units to be deleted inside one of the <code>units</code> lists,<br />
6. remove the corresponding entry in said list.<br />
7. Open new json file and write updated dictionary to it,<br />
8. delete old json file,<br />
9. rename new file with the name of old,<br />
10. run <code>make_dropdown</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>      tst <span class="op">=</span> [v.get(<span class="st">&quot;units&quot;</span>) <span class="cf">for</span> v <span class="kw">in</span> data[<span class="st">&quot;dropinfo&quot;</span>]]</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> decision_lst <span class="kw">not</span> <span class="kw">in</span> tst:</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> u <span class="kw">in</span> decision_lst:</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>              <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data[<span class="st">&quot;dropinfo&quot;</span>])):</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">if</span> u <span class="kw">in</span> data[<span class="st">&quot;dropinfo&quot;</span>][t][<span class="st">&quot;units&quot;</span>]:</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>                      data[<span class="st">&quot;dropinfo&quot;</span>][t][<span class="st">&quot;units&quot;</span>].remove(u)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>                  <span class="bu">open</span>(<span class="ss">f&quot;</span><span class="sc">{</span>monitor<span class="sc">}</span><span class="ss">/dropdown_info1.json&quot;</span>, <span class="st">&quot;w&quot;</span>).write(json.dumps(data, indent<span class="op">=</span><span class="dv">4</span>, sort_keys<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>                  os.remove(<span class="ss">f&quot;</span><span class="sc">{</span>monitor<span class="sc">}</span><span class="ss">/dropdown_info.json&quot;</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>                  os.rename(<span class="ss">f&quot;</span><span class="sc">{</span>monitor<span class="sc">}</span><span class="ss">/dropdown_info1.json&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>monitor<span class="sc">}</span><span class="ss">/dropdown_info.json&quot;</span>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>                  make_dropdown()</span></code></pre></div>
<p>Here is the full code:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>      <span class="at">@snoop</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> delete_service(<span class="va">self</span>):</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>          <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">          First stops the unit, then disables it and</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">          lastly, deletes files. If service is</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">          completely erased, it&#39;ll delete also the</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">          entry on the json file and run again the</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">          dropdown creation file.</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co">          The reason I repeated the &#39;stop_service&#39;</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">          and &#39;daemon_reload&#39; methods, instead of</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co">          simply calling them from this method, is</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co">          that if I did that, there would be a lot</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co">          of spurious empty and dotted lines. This</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co">          way the presentation is cleaner.</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="co">          &quot;&quot;&quot;</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>          <span class="cf">with</span> <span class="bu">open</span>(<span class="st">&quot;/home/mic/python/service_monitoring/service_monitoring/dropdown_info.json&quot;</span>, <span class="st">&quot;r&quot;</span>) <span class="im">as</span> f:</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>              servs <span class="op">=</span> f.read()  <span class="co"># It has to be read(), not readlines(), because the latter is a list.</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>          info <span class="op">=</span> json.loads(servs)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>          decision_lst <span class="op">=</span> []</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="st">&quot;dummy_service&quot;</span> <span class="kw">not</span> <span class="kw">in</span> <span class="va">self</span>.units:</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>              <span class="cf">for</span> unit <span class="kw">in</span> <span class="va">self</span>.units:</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>                  decision <span class="op">=</span> <span class="bu">input</span>(click.style(<span class="ss">f&quot; ++ Do you want to disable unit </span><span class="sc">{</span>unit<span class="sc">}</span><span class="ss">? [y/n] &quot;</span>, fg<span class="op">=</span><span class="st">&quot;bright_white&quot;</span>, bold<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">if</span> decision <span class="op">==</span> <span class="st">&quot;y&quot;</span>:</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>                      decision_lst.append(<span class="ss">f&quot;</span><span class="sc">{</span>unit<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span>:</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>              deci <span class="op">=</span> <span class="bu">input</span>(click.style(<span class="st">&quot; ++ What unit(s) do you want to delete? &quot;</span>, fg<span class="op">=</span><span class="st">&quot;bright_white&quot;</span>, bold<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> deci <span class="op">==</span> <span class="st">&quot;&quot;</span>:</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>                  sys.exit()</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>              <span class="cf">else</span>:</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>                  decision <span class="op">=</span> deci.split(<span class="st">&quot; &quot;</span>)</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>              <span class="cf">for</span> i <span class="kw">in</span> decision:</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>                  decision_lst.append(i)</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> service <span class="kw">in</span> decision_lst:</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>              cmd15 <span class="op">=</span> <span class="ss">f&quot;sudo systemctl stop </span><span class="sc">{</span>service<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>              subprocess.run(cmd15, shell<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>              cmd16 <span class="op">=</span> <span class="ss">f&quot;sudo systemctl disable </span><span class="sc">{</span>service<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>              subprocess.run(cmd16, shell<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>              cmd18 <span class="op">=</span> <span class="ss">f&quot;sudo rm /usr/lib/systemd/system/</span><span class="sc">{</span>service<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>              subprocess.run(cmd18, shell<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>              cmd17 <span class="op">=</span> <span class="st">&quot;sudo systemctl daemon-reload&quot;</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>              subprocess.run(cmd17, shell<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>              cmd19 <span class="op">=</span> <span class="st">&quot;sudo systemctl reset-failed&quot;</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>              subprocess.run(cmd19, shell<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>          monitor <span class="op">=</span> <span class="st">&quot;/home/mic/python/service_monitoring/service_monitoring&quot;</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>          data <span class="op">=</span> json.load(<span class="bu">open</span>(<span class="ss">f&quot;</span><span class="sc">{</span>monitor<span class="sc">}</span><span class="ss">/dropdown_info.json&quot;</span>))</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data[<span class="st">&quot;dropinfo&quot;</span>])):</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> decision_lst <span class="op">==</span> data[<span class="st">&quot;dropinfo&quot;</span>][i][<span class="st">&quot;units&quot;</span>]:</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>                  data[<span class="st">&quot;dropinfo&quot;</span>].pop(i)</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>              <span class="bu">open</span>(<span class="ss">f&quot;</span><span class="sc">{</span>monitor<span class="sc">}</span><span class="ss">/dropdown_info1.json&quot;</span>, <span class="st">&quot;w&quot;</span>).write(json.dumps(data, indent<span class="op">=</span><span class="dv">4</span>, sort_keys<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>              os.remove(<span class="ss">f&quot;</span><span class="sc">{</span>monitor<span class="sc">}</span><span class="ss">/dropdown_info.json&quot;</span>)</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>              os.rename(<span class="ss">f&quot;</span><span class="sc">{</span>monitor<span class="sc">}</span><span class="ss">/dropdown_info1.json&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>monitor<span class="sc">}</span><span class="ss">/dropdown_info.json&quot;</span>)</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>              make_dropdown()</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>          tst <span class="op">=</span> [v.get(<span class="st">&quot;units&quot;</span>) <span class="cf">for</span> v <span class="kw">in</span> data[<span class="st">&quot;dropinfo&quot;</span>]]</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> decision_lst <span class="kw">not</span> <span class="kw">in</span> tst:</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>              <span class="cf">for</span> u <span class="kw">in</span> decision_lst:</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data[<span class="st">&quot;dropinfo&quot;</span>])):</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>                      <span class="cf">if</span> u <span class="kw">in</span> data[<span class="st">&quot;dropinfo&quot;</span>][t][<span class="st">&quot;units&quot;</span>]:</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>                          data[<span class="st">&quot;dropinfo&quot;</span>][t][<span class="st">&quot;units&quot;</span>].remove(u)</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>                      <span class="bu">open</span>(<span class="ss">f&quot;</span><span class="sc">{</span>monitor<span class="sc">}</span><span class="ss">/dropdown_info1.json&quot;</span>, <span class="st">&quot;w&quot;</span>).write(json.dumps(data, indent<span class="op">=</span><span class="dv">4</span>, sort_keys<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>                      os.remove(<span class="ss">f&quot;</span><span class="sc">{</span>monitor<span class="sc">}</span><span class="ss">/dropdown_info.json&quot;</span>)</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>                      os.rename(<span class="ss">f&quot;</span><span class="sc">{</span>monitor<span class="sc">}</span><span class="ss">/dropdown_info1.json&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>monitor<span class="sc">}</span><span class="ss">/dropdown_info.json&quot;</span>)</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>                      make_dropdown()</span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>          <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n\n</span><span class="st">&quot;</span>)</span></code></pre></div>
</body>
</html>
